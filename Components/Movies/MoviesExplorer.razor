@using webxemphim.Models.DTOs
@using System.Net.Http.Json
@using System.Net.Http
@using System.Linq
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="movies-explorer">
    <div class="movies-explorer__header">
        <h1>üé¨ Kh√°m ph√°</h1>
        <p class="lead">T√¨m ki·∫øm, l·ªçc v√† duy·ªát phim t·ª´ c∆° s·ªü d·ªØ li·ªáu th·ª±c t·∫ø.</p>
    </div>

    @* Debug: Always show to confirm component is rendering *@
    <div style="display: none;" id="blazor-component-loaded">Component loaded</div>

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <strong>L·ªói:</strong> @_errorMessage
            <br />
            <small>Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.</small>
        </div>
    }

    <div class="movies-explorer__filters">
        <div class="filter-group">
            <label for="search">T√¨m ki·∫øm</label>
            <input id="search" @bind="_filters.Search" @bind:event="oninput" placeholder="Nh·∫≠p t√™n phim..." autocomplete="off" />
        </div>
        <div class="filter-group">
            <label for="genre">Th·ªÉ lo·∫°i</label>
            <select id="genre" @bind="_filters.Genre">
                <option value="">T·∫•t c·∫£</option>
                @foreach (var genre in _genres)
                {
                    <option value="@genre.Slug">@genre.Name</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label for="sort">S·∫Øp x·∫øp</label>
            <select id="sort" @bind="_filters.SortBy">
                <option value="viewcount">Xem nhi·ªÅu nh·∫•t</option>
                <option value="rating">ƒê√°nh gi√° cao nh·∫•t</option>
                <option value="date">M·ªõi nh·∫•t</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn neon-btn" @onclick="ApplyFilters">√Åp d·ª•ng</button>
            <button class="btn btn-outline-light" @onclick="ResetFilters">ƒê·∫∑t l·∫°i</button>
        </div>
    </div>

    @if (_movies?.Data?.Any() == true)
    {
        <div class="movies-explorer__stats">
            <div class="stat-card">
                <span class="stat-card__label">T·ªïng k·∫øt qu·∫£</span>
                <span class="stat-card__value">@TotalResults.ToString("N0")</span>
                <small>Trang @_movies!.Page / @_movies.TotalPages</small>
            </div>
            <div class="stat-card">
                <span class="stat-card__label">IMDb cao nh·∫•t</span>
                <span class="stat-card__value">@(_topRatedMovie?.Imdb?.ToString("0.0") ?? "-")</span>
                <small>@(_topRatedMovie?.Title ?? "Ch∆∞a c√≥")</small>
            </div>
            <div class="stat-card">
                <span class="stat-card__label">L∆∞·ª£t xem nhi·ªÅu nh·∫•t</span>
                <span class="stat-card__value">@FormatViewCount(_mostViewedMovie?.ViewCount ?? 0)</span>
                <small>@(_mostViewedMovie?.Title ?? "Ch∆∞a c√≥")</small>
            </div>
            <div class="stat-card">
                <span class="stat-card__label">Top th·ªÉ lo·∫°i</span>
                <div class="stat-card__tags">
                    @foreach (var (genre, count) in _genreBreakdown)
                    {
                        <span class="stat-tag">@genre <small>(@count)</small></span>
                    }
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }

    <div class="movies-explorer__content">
        @if (_isLoading)
        {
            <div class="loading-state">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu phim...</p>
            </div>
        }
        else if (_movies?.Data?.Any() == true)
        {
            <div class="movies-grid">
                @foreach (var movie in _movies.Data)
                {
                    <div class="movie-card" @onclick="() => NavigateToMovie(movie.Slug)">
                        <div class="movie-card__poster">
                            <img src="@GetPosterUrl(movie.PosterUrl)" alt="@movie.Title" loading="lazy" />
                            @if (movie.Imdb.HasValue)
                            {
                                <span class="movie-card__badge">‚≠ê @movie.Imdb.Value.ToString("0.0")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(movie.AgeRating))
                            {
                                <span class="movie-card__age">@movie.AgeRating</span>
                            }
                        </div>
                        <div class="movie-card__info">
                            <h3>@movie.Title</h3>
                            <div class="movie-card__meta">
                                @if (movie.Year.HasValue)
                                {
                                    <span><i class="bi bi-calendar-event"></i> @movie.Year</span>
                                }
                                <span><i class="bi bi-eye"></i> @FormatViewCount(movie.ViewCount)</span>
                                @if (movie.AverageRating.HasValue)
                                {
                                    <span><i class="bi bi-star-fill"></i> @movie.AverageRating.Value.ToString("0.0")</span>
                                }
                            </div>
                            @if (movie.Genres.Any())
                            {
                                <p class="movie-card__genres">@string.Join(", ", movie.Genres.Take(3))</p>
                            }
                            <div class="movie-card__actions">
                                <button class="btn btn-sm neon-btn" type="button" @onclick:stopPropagation="true" @onclick="() => NavigateToWatch(movie.Slug)">Xem ngay</button>
                                <button class="btn btn-sm btn-outline-light" type="button" @onclick:stopPropagation="true" @onclick="() => NavigateToDetail(movie.Slug)">Chi ti·∫øt</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <h3>Kh√¥ng t√¨m th·∫•y phim ph√π h·ª£p</h3>
                <p>Th·ª≠ thay ƒë·ªïi ƒëi·ªÅu ki·ªán l·ªçc ho·∫∑c t√¨m ki·∫øm t·ª´ kho√° kh√°c.</p>
            </div>
        }
    </div>

    @if (_movies != null && _movies.TotalPages > 1)
    {
        <div class="pagination">
            <button class="btn btn-outline-light"
                    disabled="@(!_movies.HasPrevious)"
                    @onclick="() => ChangePage(_filters.Page - 1)">
                ‚óÄ Tr∆∞·ªõc
            </button>
            <span>Trang @_movies.Page / @_movies.TotalPages</span>
            <button class="btn btn-outline-light"
                    disabled="@(!_movies.HasNext)"
                    @onclick="() => ChangePage(_filters.Page + 1)">
                Sau ‚ñ∂
            </button>
        </div>
    }
</div>

@code {
    private readonly MoviesFilterState _filters = new();
    private List<GenreDto> _genres = new();
    private PagedResultDto<MovieListItemDto>? _movies;
    private bool _isLoading = true;
    private string? _errorMessage;

    private MovieListItemDto? _topRatedMovie;
    private MovieListItemDto? _mostViewedMovie;
    private IReadOnlyList<(string Genre, int Count)> _genreBreakdown = Array.Empty<(string, int)>();

    private int TotalResults => _movies?.TotalCount ?? 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadGenresAsync();
        await LoadMoviesAsync();
    }

    private async Task LoadGenresAsync()
    {
        try
        {
            var client = CreateClient();
            var response = await client.GetFromJsonAsync<List<GenreDto>>("/api/v2/genres");
            _genres = response ?? new List<GenreDto>();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch th·ªÉ lo·∫°i: {ex.Message}";
        }
    }

    private async Task LoadMoviesAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var client = CreateClient();
            var query = BuildQueryString();
            var endpoint = $"/api/v2/movies?{query}";
            
            var httpResponse = await client.GetAsync(endpoint);
            
            if (httpResponse.IsSuccessStatusCode)
            {
                var response = await httpResponse.Content.ReadFromJsonAsync<PagedResultDto<MovieListItemDto>>();
                
                if (response is not null)
                {
                    _movies = response;
                    _filters.Page = response.Page;
                    ComputeDerivedStats();
                }
                else
                {
                    _movies = new PagedResultDto<MovieListItemDto>();
                    ComputeDerivedStats();
                }
            }
            else
            {
                var errorContent = await httpResponse.Content.ReadAsStringAsync();
                _errorMessage = $"L·ªói HTTP {(int)httpResponse.StatusCode}: {httpResponse.ReasonPhrase}. {errorContent}";
                _movies = new PagedResultDto<MovieListItemDto>();
                ComputeDerivedStats();
            }
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = $"Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server: {ex.Message}";
            _movies = new PagedResultDto<MovieListItemDto>();
            ComputeDerivedStats();
        }
        catch (Exception ex)
        {
            _errorMessage = $"L·ªói kh√¥ng x√°c ƒë·ªãnh: {ex.Message}. Chi ti·∫øt: {ex.GetType().Name}";
            _movies = new PagedResultDto<MovieListItemDto>();
            ComputeDerivedStats();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ComputeDerivedStats()
    {
        var source = _movies?.Data ?? new List<MovieListItemDto>();
        _topRatedMovie = source
            .Where(m => m.Imdb.HasValue)
            .OrderByDescending(m => m.Imdb)
            .FirstOrDefault();

        _mostViewedMovie = source
            .OrderByDescending(m => m.ViewCount)
            .FirstOrDefault();

        _genreBreakdown = source
            .SelectMany(m => m.Genres)
            .Where(g => !string.IsNullOrWhiteSpace(g))
            .GroupBy(g => g)
            .OrderByDescending(g => g.Count())
            .Take(4)
            .Select(g => (g.Key, g.Count()))
            .ToList();
    }

    private HttpClient CreateClient()
    {
        var client = HttpClientFactory.CreateClient();
        client.BaseAddress = new Uri(Navigation.BaseUri);
        client.Timeout = TimeSpan.FromSeconds(30);
        return client;
    }

    private string BuildQueryString()
    {
        var parameters = new List<string>
        {
            $"page={_filters.Page}",
            $"pageSize={_filters.PageSize}",
            $"sortBy={_filters.SortBy}"
        };

        if (!string.IsNullOrWhiteSpace(_filters.Search))
        {
            parameters.Add($"search={Uri.EscapeDataString(_filters.Search)}");
        }
        if (!string.IsNullOrWhiteSpace(_filters.Genre))
        {
            parameters.Add($"genre={Uri.EscapeDataString(_filters.Genre)}");
        }

        return string.Join("&", parameters);
    }

    private async Task ApplyFilters()
    {
        _filters.Page = 1;
        await LoadMoviesAsync();
    }

    private async Task ResetFilters()
    {
        _filters.Reset();
        await LoadMoviesAsync();
    }

    private async Task ChangePage(int page)
    {
        if (_movies == null || page < 1 || page > _movies.TotalPages)
        {
            return;
        }

        _filters.Page = page;
        await LoadMoviesAsync();
        await ScrollToTopAsync();
    }

    private Task ScrollToTopAsync() => JS.InvokeVoidAsync("window.scrollTo", new { top = 0, behavior = "smooth" }).AsTask();

    private void NavigateToMovie(string? slug)
    {
        if (!string.IsNullOrWhiteSpace(slug))
        {
            Navigation.NavigateTo($"/movie/{slug}");
        }
    }

    private void NavigateToWatch(string? slug)
    {
        if (!string.IsNullOrWhiteSpace(slug))
        {
            Navigation.NavigateTo($"/watch/{slug}");
        }
    }

    private void NavigateToDetail(string? slug)
    {
        if (!string.IsNullOrWhiteSpace(slug))
        {
            Navigation.NavigateTo($"/movie/{slug}");
        }
    }

    private static string GetPosterUrl(string? posterUrl)
    {
        if (string.IsNullOrWhiteSpace(posterUrl))
        {
            return "/favicon.ico";
        }

        if (posterUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase))
        {
            return $"/img/resize?url={Uri.EscapeDataString(posterUrl)}&w=300&q=80";
        }

        return posterUrl;
    }

    private static string FormatViewCount(long viewCount)
    {
        return viewCount switch
        {
            >= 1_000_000 => $"{viewCount / 1_000_000.0:F1}M l∆∞·ª£t xem",
            >= 1_000 => $"{viewCount / 1_000.0:F1}K l∆∞·ª£t xem",
            _ => $"{viewCount} l∆∞·ª£t xem"
        };
    }

    private sealed class MoviesFilterState
    {
        public string? Search { get; set; }
        public string? Genre { get; set; }
        public string SortBy { get; set; } = "viewcount";
        public int Page { get; set; } = 1;
        public int PageSize { get; set; } = 24;

        public void Reset()
        {
            Search = string.Empty;
            Genre = string.Empty;
            SortBy = "viewcount";
            Page = 1;
            PageSize = 24;
        }
    }
}
