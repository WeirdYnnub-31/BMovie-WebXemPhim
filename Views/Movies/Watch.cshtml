@model webxemphim.Models.Movie
@{
    ViewData["Title"] = "Xem phim";
    var srcs = ViewBag.Sources as List<webxemphim.Models.MovieSource> ?? new();
    var videoSrc = srcs.FirstOrDefault();
    var episodes = ViewBag.Episodes as List<int> ?? new();
    var selectedEpisode = ViewBag.SelectedEpisode as int? ?? 1;
    var comments = ViewBag.ApprovedComments as List<webxemphim.Models.Comment> ?? new();
    var recommendedMovies = ViewBag.RecommendedMovies as List<webxemphim.Models.Movie> ?? new();
    var subtitles = ViewBag.Subtitles as List<webxemphim.Models.Subtitle> ?? new();
    var userSubtitleSettings = ViewBag.UserSubtitleSettings as webxemphim.Models.UserSubtitleSettings;
    var castList = !string.IsNullOrWhiteSpace(Model.Cast) ? Model.Cast.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() : new List<string>();
    string GetType(string? url) => !string.IsNullOrEmpty(url) && (url!.Contains("iframe") || url.Contains("embed") || url.Contains(".php")) ? "embed" : "file";
    
    string GetContentTypeIcon(ContentType type)
    {
        return type switch
        {
            ContentType.TVShow => "üì∫",
            ContentType.Anime => "üéå",
            ContentType.Trailer => "üé•",
            ContentType.BehindTheScenes => "üé¨",
            ContentType.Documentary => "üìö",
            ContentType.ShortFilm => "üéûÔ∏è",
            _ => "üé¨"
        };
    }
    
    string GetContentTypeName(ContentType type)
    {
        return type switch
        {
            ContentType.TVShow => "TV Series",
            ContentType.Anime => "Anime",
            ContentType.Trailer => "Trailer",
            ContentType.BehindTheScenes => "Behind the Scenes",
            ContentType.Documentary => "Phim t√†i li·ªáu",
            ContentType.ShortFilm => "Phim ng·∫Øn",
            _ => "Phim"
        };
    }
}
<link rel="stylesheet" href="~/css/movie-detail-watch.css" asp-append-version="true" />
<style>
    .watch-breadcrumb { margin-bottom: 1rem; }
    .watch-breadcrumb a { color: #a259d9; text-decoration: none; }
    .watch-breadcrumb a:hover { text-decoration: underline; }
    .source-pill { border-radius:999px; padding:.45rem .9rem; border:1px solid rgba(162,89,217,.4); background:rgba(20,14,30,.5); color:#fff; cursor:pointer; transition:all 0.2s; }
    .source-pill.active, .source-pill:hover { background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b0b1e; border-color:transparent; }
    .player-shell { position:relative; width:100%; border-radius:12px; overflow:hidden; background:#0f0b1c; box-shadow:0 8px 24px rgba(0,0,0,0.3); margin-bottom: 1.5rem; }
    .player-16x9 { position:relative; width:100%; padding-top:56.25%; }
    .player-16x9 iframe, .player-16x9 video { position:absolute; inset:0; width:100%; height:100%; border:0; }
    .movie-info-section { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .movie-info-thumbnail { flex-shrink: 0; width: 120px; height: 160px; border-radius: 8px; overflow: hidden; }
    .movie-info-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .movie-info-content { flex: 1; }
    .movie-info-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
    .movie-info-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; color: #bcbfe0; font-size: 0.9rem; }
    .movie-info-genres { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
    .genre-tag { padding: 0.25rem 0.75rem; background: rgba(162,89,217,0.2); border: 1px solid rgba(162,89,217,0.4); border-radius: 16px; font-size: 0.85rem; color: #fff; }
    .movie-info-description { color: #bcbfe0; line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem; }
    .movie-info-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .action-btn { padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(162,89,217,0.4); background: rgba(20,14,30,0.5); color: #fff; text-decoration: none; font-size: 0.9rem; transition: all 0.2s; }
    .action-btn:hover { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b0b1e; border-color: transparent; }
    .episodes-section { margin-bottom: 2rem; }
    .episodes-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    .episodes-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .episode-btn { padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(162,89,217,0.4); background: rgba(20,14,30,0.5); color: #fff; text-decoration: none; transition: all 0.2s; }
    .episode-btn:hover, .episode-btn.active { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b0b1e; border-color: transparent; }
    .comments-section { margin-bottom: 2rem; }
    .comments-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    .comment-form { margin-bottom: 1.5rem; }
    .comment-textarea { width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(20,14,30,0.5); border: 1px solid rgba(162,89,217,0.4); color: #fff; resize: vertical; min-height: 80px; }
    .comment-textarea:focus { outline: none; border-color: var(--accent); }
    .comment-submit-btn { padding: 0.5rem 1.5rem; border-radius: 6px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b0b1e; border: none; font-weight: 600; cursor: pointer; }
    .comment-item { margin-bottom: 1rem; padding: 1rem; background: rgba(20,14,30,0.3); border-radius: 8px; }
    .comment-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: flex; align-items: center; justify-content: center; color: #0b0b1e; font-weight: 700; font-size: 0.9rem; }
    .comment-user { font-weight: 600; margin-right: 0.5rem; }
    .comment-time { color: #bcbfe0; font-size: 0.85rem; }
    .comment-content { color: #fff; line-height: 1.6; margin-bottom: 0.5rem; }
    .comment-actions { display: flex; gap: 1rem; }
    .comment-action-btn { background: none; border: none; color: #bcbfe0; cursor: pointer; font-size: 0.85rem; padding: 0.25rem 0.5rem; }
    .comment-action-btn:hover { color: var(--accent); }
    
    /* Sidebar Styles */
    aside { position: sticky; top: 20px; align-self: start; max-height: calc(100vh - 40px); overflow-y: auto; }
    .sidebar-section { background: rgba(20,14,30,0.5); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid rgba(162,89,217,0.2); transition: all 0.3s ease; }
    .sidebar-section:hover { border-color: rgba(162,89,217,0.4); box-shadow: 0 4px 12px rgba(162,89,217,0.1); }
    .sidebar-section:last-child { margin-bottom: 0; }
    .sidebar-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #fff; border-bottom: 2px solid rgba(162,89,217,0.3); padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    
    /* Stats Card */
    .stats-card { background: linear-gradient(135deg, rgba(162,89,217,0.1) 0%, rgba(20,14,30,0.5) 100%); border: 1px solid rgba(162,89,217,0.3); border-radius: 12px; padding: 1.5rem; }
    .stat-item { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(162,89,217,0.1); }
    .stat-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .stat-label { color: #bcbfe0; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { color: #fff; font-size: 1.5rem; font-weight: 700; }
    
    /* Info Card */
    .info-card { background: transparent; padding: 0; }
    .info-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .info-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(162,89,217,0.1); }
    .info-item:last-child { border-bottom: none; }
    .info-label { color: #bcbfe0; font-size: 0.9rem; }
    .info-value { color: #fff; font-size: 0.9rem; font-weight: 500; text-align: right; }
    
    /* Cast List */
    .cast-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .cast-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background 0.2s ease; }
    .cast-item:hover { background: rgba(162,89,217,0.1); }
    .cast-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, rgba(162,89,217,0.3) 0%, rgba(124,58,237,0.3) 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; border: 2px solid rgba(162,89,217,0.3); }
    .cast-name { color: #fff; font-size: 0.9rem; font-weight: 500; }
    
    /* Recommended List */
    .recommended-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .recommended-item { display: flex; gap: 0.75rem; text-decoration: none; padding: 0.5rem; border-radius: 8px; transition: all 0.2s ease; }
    .recommended-item:hover { background: rgba(162,89,217,0.1); transform: translateX(5px); }
    .recommended-poster { width: 70px; height: 105px; border-radius: 8px; object-fit: cover; flex-shrink: 0; border: 2px solid rgba(162,89,217,0.2); transition: border-color 0.2s ease; }
    .recommended-item:hover .recommended-poster { border-color: rgba(162,89,217,0.5); }
    .recommended-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .recommended-title { color: #fff; font-size: 0.9rem; margin-bottom: 0.35rem; font-weight: 500; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .recommended-meta { color: #bcbfe0; font-size: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.25rem; }
    
    /* Custom Scrollbar for Sidebar */
    aside::-webkit-scrollbar { width: 6px; }
    aside::-webkit-scrollbar-track { background: transparent; }
    aside::-webkit-scrollbar-thumb { background: rgba(162,89,217,0.3); border-radius: 3px; }
    aside::-webkit-scrollbar-thumb:hover { background: rgba(162,89,217,0.5); }
    
    @@media (max-width: 991.98px) {
        aside { position: static; max-height: none; }
    }

    /* Subtitle Styles */
    .subtitle-controls { padding: 0.5rem 1rem; background: rgba(20,14,30,0.8); border-radius: 8px; }
    video::cue {
        font-family: var(--subtitle-font, Arial);
        font-size: var(--subtitle-size, 16px);
        color: var(--subtitle-color, #FFFFFF);
        background-color: var(--subtitle-bg, rgba(0,0,0,0.7));
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        padding: 2px 4px;
        border-radius: 2px;
    }

    /* Picture-in-Picture Styles */
    .video-controls-overlay { opacity: 0; transition: opacity 0.3s; }
    .player-shell:hover .video-controls-overlay { opacity: 1; }
    #pip-btn { background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.3); }
    #pip-btn:hover { background: rgba(0,0,0,0.9); }

    /* Subtitle Settings Modal */
    .subtitle-settings-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
    .subtitle-settings-content { background: #1a1625; margin: 5% auto; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid rgba(162,89,217,0.4); }
    .subtitle-settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .subtitle-settings-title { font-size: 1.25rem; font-weight: 600; color: #fff; }
    .subtitle-settings-close { background: none; border: none; color: #bcbfe0; font-size: 1.5rem; cursor: pointer; }
    .subtitle-settings-close:hover { color: #fff; }
    .subtitle-settings-group { margin-bottom: 1.5rem; }
    .subtitle-settings-label { display: block; margin-bottom: 0.5rem; color: #bcbfe0; font-size: 0.9rem; }
    .subtitle-settings-input { width: 100%; padding: 0.5rem; border-radius: 6px; background: rgba(20,14,30,0.8); border: 1px solid rgba(162,89,217,0.4); color: #fff; }
    .subtitle-settings-input:focus { outline: none; border-color: var(--accent); }
    .subtitle-settings-btn-group { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem; }
    .subtitle-settings-btn { padding: 0.5rem 1.5rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
    .subtitle-settings-btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b0b1e; }
    .subtitle-settings-btn-secondary { background: rgba(20,14,30,0.8); color: #fff; border: 1px solid rgba(162,89,217,0.4); }
</style>

<div class="watch-page">
    <div class="watch-wrapper">
        <div class="watch-breadcrumb">
            <a href="@Url.Action("Index", "Home")">‚Üê Xem phim @Model.Title</a>
        </div>

        @if (srcs.Count == 0 && !ViewBag.UsingTrailer)
        {
            <div class="alert alert-info bg-glass border-0 rounded-4 text-center mb-4">Ch∆∞a c·∫≠p nh·∫≠t video cho phim n√†y!</div>
        }

        <div class="watch-player-shell">
            @if (srcs.Count > 0)
            {
                <div class="watch-meta-bar">
                    @foreach (var s in srcs)
                    {
                        <button type="button" class="source-pill source-btn @(s.IsDefault ? "active" : "")" data-url="@s.Url" data-type="@GetType(s.Url)" data-server="@s.ServerName">@s.ServerName</button>
                    }
                </div>
            }
            <div id="player-wrap" class="player-shell">
                <div class="player-16x9">
                    @if (videoSrc != null && GetType(videoSrc.Url) == "embed")
                    {
                        <iframe src="@videoSrc.Url" allowfullscreen></iframe>
                    }
                    else if (videoSrc != null && !string.IsNullOrEmpty(videoSrc.Url))
                    {
                        <video id="main-video" controls poster="@Model.PosterUrl" crossorigin="anonymous" playsinline>
                            <source src="@videoSrc.Url" type="video/mp4">
                            @foreach (var subtitle in subtitles)
                            {
                                <track kind="subtitles" src="@subtitle.FileUrl" srclang="@subtitle.Language" label="@subtitle.LanguageName" @(subtitle.IsDefault ? "default" : "")>
                            }
                            Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t video n√†y.
                        </video>
                        <input type="hidden" id="movie-id" value="@Model.Id" />
                        <input type="hidden" id="episode-number" value="@selectedEpisode" />
                        <button id="pip-btn" class="btn btn-sm btn-outline-light" style="position:absolute;top:10px;right:10px;z-index:10;display:none;">‚õ∂ Picture-in-Picture</button>
                    }
                    else
                    {
                        <div class="alert alert-info bg-glass border-0 rounded-4 text-center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">Ch∆∞a c·∫≠p nh·∫≠t video cho phim n√†y!</div>
                    }
                </div>
            </div>
        </div>

        <div class="watch-layout">
            <div>
                <div class="movie-info-section">
                    <div class="movie-info-thumbnail">
                        <img src="@(string.IsNullOrWhiteSpace(Model.PosterUrl) ? "/favicon.ico" : $"/img/resize?url={System.Net.WebUtility.UrlEncode(Model.PosterUrl)}&w=240&q=80")" alt="@Model.Title" />
                    </div>
                    <div class="movie-info-content">
                        <h2 class="movie-info-title">@Model.Title</h2>
                        <div class="movie-info-meta">
                            @if (Model.IsSeries && episodes.Count > 0)
                            {
                                <span>T·∫≠p @selectedEpisode</span>
                            }
                            @if (Model.DurationMinutes.HasValue)
                            {
                                <span>@Model.DurationMinutes ph√∫t</span>
                            }
                            @if (Model.Year.HasValue)
                            {
                                <span>@Model.Year</span>
                            }
                            @if (Model.Imdb.HasValue)
                            {
                                <span>‚≠ê @Model.Imdb.Value.ToString("0.0")</span>
                            }
                        </div>
                        @if (Model.MovieGenres?.Any() == true)
                        {
                            <div class="movie-info-genres">
                                @foreach (var genre in Model.MovieGenres.Take(5))
                                {
                                    <span class="genre-tag">@genre.Genre.Name</span>
                                }
                            </div>
                        }
                        <div class="movie-info-description">
                            @(Model.Description ?? "Kh√¥ng c√≥ m√¥ t·∫£")
                        </div>
                        <div class="movie-info-actions">
                            <form method="post" asp-controller="Inventory" asp-action="AddFavorite" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="movieId" value="@Model.Id" />
                                <button class="action-btn" type="submit">‚ù§Ô∏è Y√™u th√≠ch</button>
                            </form>
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                @if (Model.IsDownloadable && videoSrc != null && GetType(videoSrc.Url) != "embed")
                                {
                                    <button class="action-btn" id="download-btn" data-movie-id="@Model.Id" data-source-url="@videoSrc.Url" onclick="downloadMovie(@Model.Id, '@videoSrc.Url')">üíæ T·∫£i xu·ªëng</button>
                                }
                                <div class="dropdown d-inline">
                                    <button class="action-btn dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        üîó Chia s·∫ª
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="shareDropdown">
                                        <li><a class="dropdown-item" href="#" onclick="shareMovie('Facebook', @Model.Id); return false;">Facebook</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="shareMovie('Twitter', @Model.Id); return false;">Twitter</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="shareMovie('WhatsApp', @Model.Id); return false;">WhatsApp</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="shareMovie('CopyLink', @Model.Id); return false;">Sao ch√©p li√™n k·∫øt</a></li>
                                    </ul>
                                </div>
                                <a class="action-btn" asp-controller="Feedback" asp-action="Create" asp-route-movieId="@Model.Id">‚ö†Ô∏è B√°o l·ªói</a>
                            }
                        </div>
                    </div>
                </div>

                @if (Model.IsSeries && episodes.Count > 1)
                {
                    <div class="episodes-section">
                        <h3 class="episodes-title">T·∫≠p phim</h3>
                        <div class="episodes-grid">
                            @foreach (var epNum in episodes)
                            {
                                <a href="@Url.Action("Watch", new { slug = Model.Slug, ep = epNum })" class="episode-btn @(epNum == selectedEpisode ? "active" : "")">T·∫≠p @epNum</a>
                            }
                        </div>
                    </div>
                }

                @if (TempData["CommentNotice"] != null)
                {
                    <div class="alert alert-info bg-glass border-0 rounded-4 mb-3">@TempData["CommentNotice"]</div>
                }

                <div class="comments-section">
                    <h3 class="comments-title">B√¨nh lu·∫≠n (@comments.Count)</h3>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="comment-form">
                            <form method="post" asp-controller="Comments" asp-action="Create">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="movieId" value="@Model.Id" />
                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                <textarea name="content" class="comment-textarea" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." maxlength="1000" required></textarea>
                                <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span class="comment-counter" style="color: #bcbfe0; font-size: 0.85rem;">0/1000</span>
                                    <button type="submit" class="comment-submit-btn">G·ª≠i</button>
                                </div>
                            </form>
                        </div>
                    }
                    else
                    {
                        <div class="comment-form">
                            <p style="color: #bcbfe0; text-align: center; padding: 1rem;">Vui l√≤ng <a href="@Url.Action("Login", "Account")" style="color: var(--accent);">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n</p>
                        </div>
                    }

                    <div class="comments-list">
                        @if (comments.Any())
                        {
                            @foreach (var comment in comments)
                            {
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <div class="comment-avatar">
                                            @(comment.User?.Email?.FirstOrDefault().ToString().ToUpper() ?? "U")
                                        </div>
                                        <div>
                                            <span class="comment-user">@(comment.User?.UserName ?? comment.User?.Email ?? "Anonymous")</span>
                                            <span class="comment-time">@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                    </div>
                                    <div class="comment-content">@comment.Content</div>
                                </div>
                            }
                        }
                        else
                        {
                            <p style="color: #bcbfe0; text-align: center; padding: 2rem;">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n!</p>
                        }
                    </div>
                </div>
            </div>

            <aside class="detail-sidebar">
        <!-- Movie Stats Section -->
        <div class="sidebar-section">
            <div class="stats-card">
                <div class="stat-item">
                    <div class="stat-label">L∆∞·ª£t xem</div>
                    <div class="stat-value">@Model.ViewCount.ToString("N0")</div>
                </div>
                @if (Model.AverageRating.HasValue)
                {
                    <div class="stat-item">
                        <div class="stat-label">ƒê√°nh gi√°</div>
                        <div class="stat-value">‚≠ê @Model.AverageRating.Value.ToString("0.0")</div>
                    </div>
                }
                @if (Model.TotalRatings > 0)
                {
                    <div class="stat-item">
                        <div class="stat-label">S·ªë l∆∞·ª£t ƒë√°nh gi√°</div>
                        <div class="stat-value">@Model.TotalRatings</div>
                    </div>
                }
            </div>
        </div>

        <!-- Movie Info Card -->
        <div class="sidebar-section">
            <div class="info-card">
                <h3 class="sidebar-title">Th√¥ng tin phim</h3>
                <div class="info-list">
                    @if (Model.Year.HasValue)
                    {
                        <div class="info-item">
                            <span class="info-label">NƒÉm:</span>
                            <span class="info-value">@Model.Year</span>
                        </div>
                    }
                    @if (Model.DurationMinutes.HasValue)
                    {
                        <div class="info-item">
                            <span class="info-label">Th·ªùi l∆∞·ª£ng:</span>
                            <span class="info-value">@Model.DurationMinutes ph√∫t</span>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(Model.Country))
                    {
                        <div class="info-item">
                            <span class="info-label">Qu·ªëc gia:</span>
                            <span class="info-value">@Model.Country</span>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(Model.Director))
                    {
                        <div class="info-item">
                            <span class="info-label">ƒê·∫°o di·ªÖn:</span>
                            <span class="info-value">@Model.Director</span>
                        </div>
                    }
                    @if (Model.ReleaseDate.HasValue)
                    {
                        <div class="info-item">
                            <span class="info-label">Ng√†y ph√°t h√†nh:</span>
                            <span class="info-value">@Model.ReleaseDate.Value.ToString("dd/MM/yyyy")</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Cast Section -->
        @if (castList.Any()) {
            <div class="sidebar-section">
                <h3 class="sidebar-title">Di·ªÖn vi√™n</h3>
                <div class="cast-list">
                    @foreach (var cast in castList.Take(8))
                    {
                        <div class="cast-item">
                            <div class="cast-avatar">@cast.FirstOrDefault().ToString().ToUpper()</div>
                            <div class="cast-name">@cast</div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Same Genre Movies -->
        @{
            var sameGenreMovies = ViewBag.SameGenreMovies as List<webxemphim.Models.Movie> ?? new();
        }
        @if (sameGenreMovies.Any()) {
            <div class="sidebar-section">
                <h3 class="sidebar-title">C√πng th·ªÉ lo·∫°i</h3>
                <div class="recommended-list">
                    @foreach (var movie in sameGenreMovies.Take(5))
                    {
                        <a href="@Url.Action("Watch", new { slug = movie.Slug })" class="recommended-item">
                            <img src="@(string.IsNullOrWhiteSpace(movie.PosterUrl) ? "/favicon.ico" : $"/img/resize?url={System.Net.WebUtility.UrlEncode(movie.PosterUrl)}&w=120&q=70")" alt="@movie.Title" class="recommended-poster" />
                            <div class="recommended-info">
                                <div class="recommended-title">@movie.Title</div>
                                <div class="recommended-meta">
                                    @if (movie.Year.HasValue) { <span>@movie.Year</span> }
                                    @if (movie.Imdb.HasValue) { <span> ‚Ä¢ ‚≠ê @movie.Imdb.Value.ToString("0.0")</span> }
                                    @if (movie.ViewCount > 0) { <span> ‚Ä¢ üëÅÔ∏è @(movie.ViewCount >= 1000 ? $"{movie.ViewCount / 1000.0:F1}K" : movie.ViewCount.ToString())</span> }
                                </div>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }

        <!-- Recommendations Section -->
        @if (recommendedMovies.Any()) {
            <div class="sidebar-section">
                <h3 class="sidebar-title">ƒê·ªÅ xu·∫•t cho b·∫°n</h3>
                <div class="recommended-list">
                    @foreach (var movie in recommendedMovies.Take(5))
                    {
                        <a href="@Url.Action("Watch", new { slug = movie.Slug })" class="recommended-item">
                            <img src="@(string.IsNullOrWhiteSpace(movie.PosterUrl) ? "/favicon.ico" : $"/img/resize?url={System.Net.WebUtility.UrlEncode(movie.PosterUrl)}&w=120&q=70")" alt="@movie.Title" class="recommended-poster" />
                            <div class="recommended-info">
                                <div class="recommended-title">@movie.Title</div>
                                <div class="recommended-meta">
                                    @if (movie.Year.HasValue) { <span>@movie.Year</span> }
                                    @if (movie.Imdb.HasValue) { <span> ‚Ä¢ ‚≠ê @movie.Imdb.Value.ToString("0.0")</span> }
                                    @if (movie.ViewCount > 0) { <span> ‚Ä¢ üëÅÔ∏è @(movie.ViewCount >= 1000 ? $"{movie.ViewCount / 1000.0:F1}K" : movie.ViewCount.ToString())</span> }
                                </div>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }

        <!-- Top Viewed Movies -->
        @{
            var topViewedMovies = ViewBag.TopViewedMovies as List<webxemphim.Models.Movie> ?? new();
        }
        @if (topViewedMovies.Any()) {
            <div class="sidebar-section">
                <h3 class="sidebar-title">üî• Phim xem nhi·ªÅu</h3>
                <div class="recommended-list">
                    @foreach (var movie in topViewedMovies.Take(5))
                    {
                        <a href="@Url.Action("Watch", new { slug = movie.Slug })" class="recommended-item">
                            <img src="@(string.IsNullOrWhiteSpace(movie.PosterUrl) ? "/favicon.ico" : $"/img/resize?url={System.Net.WebUtility.UrlEncode(movie.PosterUrl)}&w=120&q=70")" alt="@movie.Title" class="recommended-poster" />
                            <div class="recommended-info">
                                <div class="recommended-title">@movie.Title</div>
                                <div class="recommended-meta">
                                    @if (movie.Year.HasValue) { <span>@movie.Year</span> }
                                    @if (movie.Imdb.HasValue) { <span> ‚Ä¢ ‚≠ê @movie.Imdb.Value.ToString("0.0")</span> }
                                    @if (movie.ViewCount > 0) { <span> ‚Ä¢ üëÅÔ∏è @(movie.ViewCount >= 1000 ? $"{movie.ViewCount / 1000.0:F1}K" : movie.ViewCount.ToString())</span> }
                                </div>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }

        <!-- Latest Movies -->
        @{
            var latestMovies = ViewBag.LatestMovies as List<webxemphim.Models.Movie> ?? new();
        }
        @if (latestMovies.Any()) {
            <div class="sidebar-section">
                <h3 class="sidebar-title">üìÖ M·ªõi c·∫≠p nh·∫≠t</h3>
                <div class="recommended-list">
                    @foreach (var movie in latestMovies.Take(5))
                    {
                        <a href="@Url.Action("Watch", new { slug = movie.Slug })" class="recommended-item">
                            <img src="@(string.IsNullOrWhiteSpace(movie.PosterUrl) ? "/favicon.ico" : $"/img/resize?url={System.Net.WebUtility.UrlEncode(movie.PosterUrl)}&w=120&q=70")" alt="@movie.Title" class="recommended-poster" />
                            <div class="recommended-info">
                                <div class="recommended-title">@movie.Title</div>
                                <div class="recommended-meta">
                                    @if (movie.Year.HasValue) { <span>@movie.Year</span> }
                                    @if (movie.Imdb.HasValue) { <span> ‚Ä¢ ‚≠ê @movie.Imdb.Value.ToString("0.0")</span> }
                                </div>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }
    </aside>
</div>
</div>
</div>

<!-- HLS.js for adaptive streaming -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Enhanced Video Player -->
<script src="~/js/video-player-enhanced.js" asp-append-version="true"></script>
<script>
    // Source switching
    document.querySelectorAll('.source-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            let url = this.getAttribute('data-url');
            let typ = this.getAttribute('data-type');
            let wrap = document.getElementById('player-wrap');
            document.querySelectorAll('.source-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            wrap.innerHTML = typ == 'embed'
                ? `<div class="player-16x9"><iframe src="${url}" allowfullscreen></iframe></div>`
                : `<div class="player-16x9"><video controls poster='@Model.PosterUrl'><source src='${url}' type='video/mp4'>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t video n√†y.</video></div>`;
        });
    });

    // Character counter for comment textarea
    document.querySelector('.comment-textarea')?.addEventListener('input', function() {
        const counter = document.querySelector('.comment-counter');
        if (counter) {
            counter.textContent = this.value.length + '/1000';
        }
    });

    // Subtitle Management
    const video = document.getElementById('main-video');
    const subtitleSelector = document.getElementById('subtitle-selector');
    const subtitleSettingsBtn = document.getElementById('subtitle-settings-btn');
    const userSubtitleSettings = @Html.Raw(userSubtitleSettings != null ? Json.Serialize(new {
        fontFamily = userSubtitleSettings.FontFamily,
        fontSize = userSubtitleSettings.FontSize,
        fontColor = userSubtitleSettings.FontColor,
        backgroundColor = userSubtitleSettings.BackgroundColor,
        backgroundOpacity = userSubtitleSettings.BackgroundOpacity,
        position = userSubtitleSettings.Position,
        showBackground = userSubtitleSettings.ShowBackground,
        preferredLanguage = userSubtitleSettings.PreferredLanguage
    }) : "null");

    // Apply user subtitle settings
    function applySubtitleSettings(settings) {
        if (!settings || !video) return;
        
        const root = document.documentElement;
        root.style.setProperty('--subtitle-font', settings.fontFamily || 'Arial');
        root.style.setProperty('--subtitle-size', (settings.fontSize || 16) + 'px');
        root.style.setProperty('--subtitle-color', settings.fontColor || '#FFFFFF');
        
        if (settings.showBackground) {
            const bgColor = settings.backgroundColor || '#000000';
            const opacity = settings.backgroundOpacity || 0.7;
            const rgba = hexToRgba(bgColor, opacity);
            root.style.setProperty('--subtitle-bg', rgba);
        } else {
            root.style.setProperty('--subtitle-bg', 'transparent');
        }
    }

    function hexToRgba(hex, opacity) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }

    // Apply settings on load
    if (userSubtitleSettings) {
        applySubtitleSettings(userSubtitleSettings);
        
        // Set preferred language
        if (subtitleSelector && userSubtitleSettings.preferredLanguage) {
            const option = Array.from(subtitleSelector.options).find(opt => opt.value === userSubtitleSettings.preferredLanguage);
            if (option) {
                subtitleSelector.value = userSubtitleSettings.preferredLanguage;
            }
        }
    }

    // Subtitle selector change
    if (subtitleSelector && video) {
        subtitleSelector.addEventListener('change', function() {
            const selectedLanguage = this.value;
            const tracks = video.textTracks;
            
            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];
                if (selectedLanguage === 'off') {
                    track.mode = 'hidden';
                } else if (track.language === selectedLanguage) {
                    track.mode = 'showing';
                } else {
                    track.mode = 'hidden';
                }
            }
        });
    }

    // Subtitle Settings Modal
    if (subtitleSettingsBtn) {
        subtitleSettingsBtn.addEventListener('click', function() {
            openSubtitleSettingsModal();
        });
    }

    function openSubtitleSettingsModal() {
        const modal = document.getElementById('subtitle-settings-modal');
        if (!modal) {
            createSubtitleSettingsModal();
        } else {
            modal.style.display = 'block';
        }
    }

    function createSubtitleSettingsModal() {
        const modal = document.createElement('div');
        modal.id = 'subtitle-settings-modal';
        modal.className = 'subtitle-settings-modal';
        modal.innerHTML = `
            <div class="subtitle-settings-content">
                <div class="subtitle-settings-header">
                    <h3 class="subtitle-settings-title">C√†i ƒë·∫∑t ph·ª• ƒë·ªÅ</h3>
                    <button class="subtitle-settings-close" onclick="closeSubtitleSettingsModal()">&times;</button>
                </div>
                <div class="subtitle-settings-group">
                    <label class="subtitle-settings-label">Font ch·ªØ</label>
                    <select id="subtitle-font-family" class="subtitle-settings-input">
                        <option value="Arial">Arial</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Tahoma">Tahoma</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                    </select>
                </div>
                <div class="subtitle-settings-group">
                    <label class="subtitle-settings-label">K√≠ch th∆∞·ªõc ch·ªØ</label>
                    <input type="range" id="subtitle-font-size" class="subtitle-settings-input" min="10" max="30" value="${userSubtitleSettings?.fontSize || 16}">
                    <span id="subtitle-font-size-value">${userSubtitleSettings?.fontSize || 16}px</span>
                </div>
                <div class="subtitle-settings-group">
                    <label class="subtitle-settings-label">M√†u ch·ªØ</label>
                    <input type="color" id="subtitle-font-color" class="subtitle-settings-input" value="${userSubtitleSettings?.fontColor || '#FFFFFF'}">
                </div>
                <div class="subtitle-settings-group">
                    <label class="subtitle-settings-label">
                        <input type="checkbox" id="subtitle-show-background" ${userSubtitleSettings?.showBackground !== false ? 'checked' : ''}>
                        Hi·ªÉn th·ªã n·ªÅn
                    </label>
                </div>
                <div class="subtitle-settings-group" id="subtitle-background-group">
                    <label class="subtitle-settings-label">M√†u n·ªÅn</label>
                    <input type="color" id="subtitle-background-color" class="subtitle-settings-input" value="${userSubtitleSettings?.backgroundColor || '#000000'}">
                </div>
                <div class="subtitle-settings-group" id="subtitle-opacity-group">
                    <label class="subtitle-settings-label">ƒê·ªô trong su·ªët n·ªÅn</label>
                    <input type="range" id="subtitle-background-opacity" class="subtitle-settings-input" min="0" max="1" step="0.1" value="${userSubtitleSettings?.backgroundOpacity || 0.7}">
                    <span id="subtitle-opacity-value">${Math.round((userSubtitleSettings?.backgroundOpacity || 0.7) * 100)}%</span>
                </div>
                <div class="subtitle-settings-btn-group">
                    <button class="subtitle-settings-btn subtitle-settings-btn-secondary" onclick="closeSubtitleSettingsModal()">H·ªßy</button>
                    <button class="subtitle-settings-btn subtitle-settings-btn-primary" onclick="saveSubtitleSettings()">L∆∞u</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Initialize values
        if (userSubtitleSettings) {
            document.getElementById('subtitle-font-family').value = userSubtitleSettings.fontFamily || 'Arial';
            document.getElementById('subtitle-font-size').value = userSubtitleSettings.fontSize || 16;
            document.getElementById('subtitle-font-color').value = userSubtitleSettings.fontColor || '#FFFFFF';
            document.getElementById('subtitle-background-color').value = userSubtitleSettings.backgroundColor || '#000000';
            document.getElementById('subtitle-background-opacity').value = userSubtitleSettings.backgroundOpacity || 0.7;
            document.getElementById('subtitle-show-background').checked = userSubtitleSettings.showBackground !== false;
        }

        // Update font size display
        document.getElementById('subtitle-font-size').addEventListener('input', function() {
            document.getElementById('subtitle-font-size-value').textContent = this.value + 'px';
        });

        // Update opacity display
        document.getElementById('subtitle-background-opacity').addEventListener('input', function() {
            document.getElementById('subtitle-opacity-value').textContent = Math.round(this.value * 100) + '%';
        });

        // Toggle background settings
        document.getElementById('subtitle-show-background').addEventListener('change', function() {
            const bgGroup = document.getElementById('subtitle-background-group');
            const opacityGroup = document.getElementById('subtitle-opacity-group');
            if (this.checked) {
                bgGroup.style.display = 'block';
                opacityGroup.style.display = 'block';
            } else {
                bgGroup.style.display = 'none';
                opacityGroup.style.display = 'none';
            }
        });

        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSubtitleSettingsModal();
            }
        });
    }

    function closeSubtitleSettingsModal() {
        const modal = document.getElementById('subtitle-settings-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function saveSubtitleSettings() {
        const settings = {
            fontFamily: document.getElementById('subtitle-font-family').value,
            fontSize: parseInt(document.getElementById('subtitle-font-size').value),
            fontColor: document.getElementById('subtitle-font-color').value,
            backgroundColor: document.getElementById('subtitle-background-color').value,
            backgroundOpacity: parseFloat(document.getElementById('subtitle-background-opacity').value),
            showBackground: document.getElementById('subtitle-show-background').checked
        };

        applySubtitleSettings(settings);

        // Save to server if authenticated
        @if (User.Identity?.IsAuthenticated == true)
        {
            <text>
            try {
                const response = await fetch('/api/subtitles/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                if (response.ok) {
                    alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t ph·ª• ƒë·ªÅ!');
                }
            } catch (error) {
                console.error('Error saving subtitle settings:', error);
            }
            </text>
        }

        closeSubtitleSettingsModal();
    }

    // Download Movie
    async function downloadMovie(movieId, sourceUrl) {
        const downloadBtn = document.getElementById('download-btn');
        if (!downloadBtn) return;
        
        try {
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'ƒêang t·∫°o link...';
            
            // Generate download token
            const response = await fetch('/api/download/token/' + movieId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ movieSourceUrl: sourceUrl })
            });
            
            if (!response.ok) {
                const error = await response.json();
                alert(error.error || 'Kh√¥ng th·ªÉ t·∫°o link download. Vui l√≤ng th·ª≠ l·∫°i.');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'üíæ T·∫£i xu·ªëng';
                return;
            }
            
            const result = await response.json();
            const token = result.token;
            
            // Redirect to download endpoint
            window.location.href = '/Download/getfile/' + token;
            
            // Reset button after a delay
            setTimeout(() => {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'üíæ T·∫£i xu·ªëng';
            }, 3000);
        } catch (error) {
            console.error('Download error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi t·∫£i xu·ªëng. Vui l√≤ng th·ª≠ l·∫°i.');
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'üíæ T·∫£i xu·ªëng';
        }
    }

    // Share Movie
    async function shareMovie(platform, movieId) {
        const url = window.location.href;
        const title = '@Model.Title';
        const text = `Xem phim "${title}" tr√™n WebXemPhim`;
        
        let shareUrl = '';
        
        switch(platform) {
            case 'Facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                window.open(shareUrl, '_blank', 'width=600,height=400');
                break;
            case 'Twitter':
                shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
                window.open(shareUrl, '_blank', 'width=600,height=400');
                break;
            case 'WhatsApp':
                shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
                window.open(shareUrl, '_blank');
                break;
            case 'CopyLink':
                try {
                    await navigator.clipboard.writeText(url);
                    alert('ƒê√£ sao ch√©p li√™n k·∫øt!');
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('ƒê√£ sao ch√©p li√™n k·∫øt!');
                }
                return; // Don't track CopyLink
        }
        
        // Track share if authenticated
        @if (User.Identity?.IsAuthenticated == true)
        {
            <text>
            try {
                await fetch('/api/social/share/@Model.Id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ platform: platform })
                });
            } catch (error) {
                console.error('Error tracking share:', error);
            }
            </text>
        }
    }

    // Like/Dislike comments
    document.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const commentId = this.getAttribute('data-comment-id');
            const isLike = this.classList.contains('like-btn');
            const action = isLike ? 'Like' : 'Dislike';
            
            try {
                const response = await fetch(`/Comments/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: `commentId=${commentId}`
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (isLike) {
                        this.innerHTML = `üëç ${result.likes || 0}`;
                    } else {
                        this.innerHTML = `üëé ${result.dislikes || 0}`;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
</script>
