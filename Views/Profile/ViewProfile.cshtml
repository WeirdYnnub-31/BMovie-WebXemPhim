@model webxemphim.Data.ApplicationUser
@{
    ViewData["Title"] = "Hồ sơ người dùng";
    var isOwnProfile = ViewBag.IsOwnProfile as bool? ?? false;
    var isFollowing = ViewBag.IsFollowing as bool? ?? false;
    var followerCount = ViewBag.FollowerCount as int? ?? 0;
    var followingCount = ViewBag.FollowingCount as int? ?? 0;
    var watchedCount = ViewBag.WatchedCount as int? ?? 0;
    var favoriteCount = ViewBag.FavoriteCount as int? ?? 0;
    var ratingCount = ViewBag.RatingCount as int? ?? 0;
    var commentCount = ViewBag.CommentCount as int? ?? 0;
    var recentComments = ViewBag.RecentComments as List<webxemphim.Models.Comment> ?? new();
    var recentRatings = ViewBag.RecentRatings as List<webxemphim.Models.Rating> ?? new();
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card bg-glass border-0 rounded-4 mb-3">
                <div class="card-body text-center">
                    <img src="@(Model.AvatarUrl ?? "/images/default-avatar.png")" alt="@Model.UserName" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;" />
                    <h4>@Model.UserName</h4>
                    @if (!string.IsNullOrEmpty(Model.Bio))
                    {
                        <p class="text-muted">@Model.Bio</p>
                    }
                    @if (!isOwnProfile && User.Identity?.IsAuthenticated == true)
                    {
                        <button id="follow-btn" class="btn @(isFollowing ? "btn-secondary" : "btn-primary") mb-3" data-user-id="@Model.Id" data-is-following="@isFollowing">
                            @(isFollowing ? "Đang theo dõi" : "Theo dõi")
                        </button>
                    }
                </div>
            </div>

            <div class="card bg-glass border-0 rounded-4">
                <div class="card-body">
                    <h5>Thống kê</h5>
                    <hr />
                    <div class="d-flex justify-content-between mb-2">
                        <span>Người theo dõi:</span>
                        <strong id="follower-count">@followerCount</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Đang theo dõi:</span>
                        <strong>@followingCount</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Đã xem:</span>
                        <strong>@watchedCount</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Yêu thích:</span>
                        <strong>@favoriteCount</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Đánh giá:</span>
                        <strong>@ratingCount</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Bình luận:</span>
                        <strong>@commentCount</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card bg-glass border-0 rounded-4 mb-3">
                <div class="card-header bg-transparent border-0">
                    <h5>Bình luận gần đây</h5>
                </div>
                <div class="card-body">
                    @if (recentComments.Any())
                    {
                        foreach (var comment in recentComments)
                        {
                            <div class="mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between">
                                    <strong><a href="@Url.Action("Watch", "Movies", new { slug = comment.Movie?.Slug })">@comment.Movie?.Title</a></strong>
                                    <small class="text-muted">@comment.CreatedAt.ToString("dd/MM/yyyy")</small>
                                </div>
                                <p class="mb-0 mt-2">@comment.Content</p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">Chưa có bình luận nào.</p>
                    }
                </div>
            </div>

            <div class="card bg-glass border-0 rounded-4">
                <div class="card-header bg-transparent border-0">
                    <h5>Đánh giá gần đây</h5>
                </div>
                <div class="card-body">
                    @if (recentRatings.Any())
                    {
                        foreach (var rating in recentRatings)
                        {
                            <div class="mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between">
                                    <strong><a href="@Url.Action("Watch", "Movies", new { slug = rating.Movie?.Slug })">@rating.Movie?.Title</a></strong>
                                    <span class="badge bg-primary">⭐ @rating.Score</span>
                                </div>
                                <small class="text-muted">@rating.CreatedAt.ToString("dd/MM/yyyy")</small>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">Chưa có đánh giá nào.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (!isOwnProfile && User.Identity?.IsAuthenticated == true)
{
    <script>
        document.getElementById('follow-btn')?.addEventListener('click', async function() {
            const userId = this.getAttribute('data-user-id');
            const isFollowing = this.getAttribute('data-is-following') === 'true';
            const action = isFollowing ? 'unfollow' : 'follow';
            
            try {
                const response = await fetch(`/api/social/${action}/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.setAttribute('data-is-following', (!isFollowing).toString());
                    this.textContent = isFollowing ? 'Theo dõi' : 'Đang theo dõi';
                    this.className = isFollowing ? 'btn btn-primary mb-3' : 'btn btn-secondary mb-3';
                    document.getElementById('follower-count').textContent = result.followerCount;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            }
        });
    </script>
}

